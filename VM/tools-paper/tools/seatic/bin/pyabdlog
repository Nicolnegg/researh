#!/usr/bin/env python3
# ----------------------------------------
import sys
import os.path
# ---------------------------------------
from seatic.abduction import AbducerLogParser
from colorama import Fore, Style
import yaml
try:
    from yaml import CLoader as ymlLoader, CDumper as ymlDumper
except ImportError:
    from yaml import Loader as ymlLoader, Dumper as ymlDumper
# ---------------------------------------
def detect_source(filename):
    if (filename.endswith('.log2') or filename.endswith('abduce-binsec.log')) and '.dir' in filename:
        return '{}.c'.format(os.path.splitext(os.path.dirname(filename))[0])
    raise ValueError(filename)
# ---------------------------------------
def expanded_data(source, tool):
    if os.path.isfile(source):
        data = dict()
        with open(source) as stream:
            for line in stream:
                rtag = '[{}:run]'.format(tool)
                if line.startswith(rtag):
                    ldata = line.replace(rtag, '').replace('seconds', '').strip()
                    lpart = [ ld.strip() for ld in ldata.split(' in ') ]
                    data['results'] = lpart[0].split('+')
                    data['time'] = float(lpart[1])
                    data['timeout'] = 'timeout' in data['results']
                    data['returncode'] = 1 if 'nzr' in data['results'] else 0
                    data['models'] = []
                    data['vulnerable'] = 'model' in data['results']
                    data['status'] = dict()
                    data['status']['goal-unreachable'] = 'unreachable' in data['results']
                if line.startswith('[source]'):
                    ldata = line.replace('[source]', '').strip()
                    data['directory'] = os.path.dirname(ldata)
                    data['problem'] = os.path.basename(ldata)
                if line.startswith('[c2bc]'):
                    ldata = line.replace('[c2bc]', '').replace('expect', '').strip()
                    data['targets'] = ldata.split('+')
        return data
    return None
# ---------------------------------------
def toolname_cv(name):
    if name == 'robust-binsec':
        return 'binsec-robust'
    return name
# ---------------------------------------
def autoexpand(source, data):
    datadir = '{}.dir'.format(os.path.splitext(source)[0])
    corename = os.path.basename(os.path.splitext(source)[0])
    blog = os.path.join(datadir, '{}.binsec.log'.format(corename))
    rlog = os.path.join(datadir, '{}.robust-binsec.log'.format(corename))
    for esource, etool in ((blog, 'binsec'), (rlog, 'robust-binsec')):
        edata = expanded_data(esource, etool)
        data[toolname_cv(etool)] = edata
# ---------------------------------------
def cleanup(data):
    data = data.replace(Style.RESET_ALL, '')
    data = data.replace(Style.DIM, '')
    data = data.replace(Style.BRIGHT, '')
    data = data.replace(Fore.CYAN, '')
    data = data.replace(Fore.YELLOW, '')
    data = data.replace(Fore.MAGENTA, '')
    data = data.replace(Fore.RED, '')
    data = data.replace(Fore.GREEN, '')
    return data
# ---------------------------------------
def handle_log(filename):
    with open(filename) as stream:
        data = stream.read()
    data = cleanup(data)
    parser = AbducerLogParser(data, None)
    digest = dict()
    digest['time'] = -1
    digest['timeout'] = None
    digest['returncode'] = 0
    digest['logfile'] = filename
    digest['constraints'] = parser.constraints
    digest['necessary'] = parser.necessary
    digest['exact'] = parser.exact
    digest['statistics'] = parser.stats
    return digest
# ---------------------------------------
def main(args):
    logdata = dict()
    for ifile in args.input:
        digest = handle_log(ifile)
        sfile = detect_source(ifile)
        logdata[sfile] = { 'abducer': digest }
        autoexpand(sfile, logdata[sfile])
    if args.mutantify is not None:
        logdata = { 'source': args.mutantify, 'mutants': logdata }
    with open(args.output, 'w') as stream:
        yaml.dump(logdata, stream, Dumper=ymlDumper)
# ----------------------------------------
# ----------------------------------------
if __name__ == '__main__':
    from argparse import ArgumentParser

    ap = ArgumentParser(description='')

    g1 = ap.add_argument_group('Core options')
    g1.add_argument('-i', '--input', action='store', nargs='+', required=True, metavar='<input.log>', help='abduction logfile to parse')
    g1.add_argument('-o', '--output', action='store', default='output.yml', metavar='<output.yml>', help='output data file')
    g1.add_argument('-m', '--mutantify', action='store', default=None, metavar='<source>', help='enclose elements under a mutants key for source <source>')

    args = ap.parse_args()

    try:
        main(args)
    except Exception as e:
        #TODO Log
        raise e
        sys.exit(1)
    sys.exit(0)
